<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Geração de PDF com jsPDF</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f4f4f9;
        }
        h1 {
            color: #333;
        }
        button {
            padding: 15px 30px;
            font-size: 16px;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>

    <h1>Teste de Geração de PDF</h1>
    <p>Clique no botão abaixo para gerar e baixar o "Termo de Referência" em PDF.</p>
    <button id="generate-pdf-btn">Gerar PDF</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
    // Adiciona o evento de clique ao botão
    document.getElementById('generate-pdf-btn').addEventListener('click', () => {
        // JSON com os dados para o template
        const jsonData = {
            "orgao_contratante": "Tribunal Regional Eleitoral do Acre",
            "tipo_contratacao": "servicos",
            "objeto_contratacao": "Contratação de empresa especializada para desenvolvimento de sistema de gestão de contratos com integração aos sistemas existentes",
            "modalidade_licitacao": "aquisicao_direta",
            "fundamentacao_legal": "A contratação fundamenta-se na Lei nº 14.133, de 2021, especialmente em seus artigos referentes à contratação de serviços, conforme detalhado no Estudo Técnico Preliminar e demais documentos do processo.",
            "descricao_solucao": "A solução consiste na contratação de empresa especializada para o desenvolvimento de um sistema de gestão de contratos com integração aos sistemas existentes, conforme detalhado no Estudo Técnico Preliminar. Trata-se de um sistema web responsivo com módulos de cadastro, gestão e relatórios de contratos. A contratação visa modernizar o processo de gestão de contratos, atualmente manual e propenso a erros, alinhando-se aos objetivos de Modernização Tecnológica, Transparência Pública e Eficiência Operacional. Esta contratação é tecnicamente viável, economicamente vantajosa, com previsão de economia anual de R$ 120.000,00 e redução de 60% no tempo de processos, e estrategicamente alinhada aos objetivos institucionais, com um ROI estimado em 18 meses.",
            "prazo_vigencia_contrato": "Inicialmente 9 meses para desenvolvimento e implantação (6 meses para desenvolvimento + 3 meses para implantação), com possibilidade de prorrogação para o serviço de manutenção e suporte contínuos, até o limite de 5 anos, prorrogáveis por até 10 anos no total, conforme os artigos 106 e 107 da Lei nº 14.133/2021.",
            "prazo_entrega_prestacao": "O prazo para desenvolvimento é de 6 meses, seguido de 3 meses para implantação. A manutenção e suporte serão contínuos após a implantação inicial.",
            "local_entrega_prestacao": "As entregas do sistema e a prestação de serviços ocorrerão nas instalações do Tribunal Regional Eleitoral do Acre, ou remotamente, conforme acordado e compatível com a natureza do serviço e as políticas de segurança da informação.",
            "obrigacoes_contratante": [
                "Fiscalizar a execução do contrato.",
                "Realizar o pagamento dos serviços contratados nos prazos e condições estabelecidos.",
                "Prestar as informações e os esclarecimentos necessários à Contratada.",
                "Disponibilizar acesso à equipe da Contratada aos sistemas e dados necessários para a execução dos serviços, observando as políticas de segurança da informação.",
                "Acompanhar o cronograma de desenvolvimento e implantação, participando das reuniões e homologações necessárias."
            ],
            "obrigacoes_contratada": [
                "Desenvolver o sistema conforme as especificações técnicas e funcionais acordadas.",
                "Garantir a integração do novo sistema com os sistemas legados existentes.",
                "Realizar a implantação e configuração do sistema nos ambientes definidos.",
                "Prestar serviços de manutenção e suporte contínuos, conforme acordado em contrato.",
                "Capacitar os usuários e a equipe técnica do Contratante para a utilização e administração do sistema.",
                "Cumprir todas as leis e regulamentos aplicáveis, incluindo os de segurança da informação e proteção de dados."
            ],
            "admite_subcontratacao": false,
            "exige_garantia_contratual": true,
            "condicoes_pagamento": "O pagamento será efetuado após o ateste de recebimento definitivo de cada etapa ou parcela do serviço, mediante apresentação de nota fiscal ou documento de cobrança equivalente, conforme cronograma de pagamentos estabelecido em contrato.",
            "sancoes_administrativas": "As sanções administrativas aplicáveis são aquelas previstas na Lei nº 14.133/2021 e demais normas pertinentes, incluindo advertência, multa, suspensão temporária de participação em licitação e impedimento de contratar com a Administração, e declaração de inidoneidade, conforme a gravidade da infração.",
            "responsavel": "João Silva, Maria Santos, Pedro Costa",
            "cargo_responsavel": "Coordenador TI, Analista de Sistemas, Arquiteto de Software (Equipe de Planejamento da Contratação)",
            "sistema_registro_precos": {
                "adota_srp": false,
                "tipo_srp": null,
                "quantidade_maxima": null,
                "quantidade_minima_cotacao": null,
                "permite_precos_diferentes": null,
                "justificativa_precos_diferentes": null,
                "permite_proposta_inferior": null,
                "criterio_julgamento": null,
                "registro_limitado": null,
                "criterio_reajuste": null,
                "vigencia_ata": null
            },
            "requisitos_contratacao": {
                "sustentabilidade": "A contratação contribuirá para a redução do uso de papel através da digitalização de processos, minimizando impactos ambientais negativos e promovendo a sustentabilidade.",
                "indicacao_marcas": "Não há indicação de marcas ou modelos específicos, priorizando a funcionalidade e o atendimento às especificações técnicas e requisitos de integração.",
                "vedacao_marca_produto": "Não há vedação específica de utilização de marca/produto, desde que atendam aos requisitos de compatibilidade e desempenho exigidos.",
                "exige_amostra": false,
                "exige_carta_solidariedade": false,
                "garantia_produto_servico": "A empresa contratada deverá oferecer garantia dos serviços de desenvolvimento por um período mínimo de 12 meses após a implantação e homologação, além de garantia de manutenção e assistência técnica contínuas conforme estabelecido em contrato.",
                "exige_vistoria": false
            },
            "modelo_execucao": {
                "condicoes_entrega": "A entrega da solução será realizada em fases, incluindo desenvolvimento e implantação, conforme cronograma aprovado. O sistema deverá ser entregue funcional e integrado aos sistemas legados, passando por testes e homologações por parte do Contratante.",
                "garantia_manutencao": "O sistema requer manutenção e suporte contínuos para garantir seu funcionamento adequado, conforme justificado no Estudo Técnico Preliminar. A contratada deverá oferecer serviços de manutenção preventiva, corretiva e evolutiva, além de suporte técnico aos usuários.",
                "materiais_fornecidos": "O Contratante não fornecerá materiais físicos para a execução dos serviços de desenvolvimento de sistema. A Contratada será responsável por todos os recursos tecnológicos (hardware, software de desenvolvimento, etc.) e humanos necessários.",
                "informacoes_proposta": "Os requisitos para a contratação incluem: Experiência comprovada em sistemas públicos, Certificação ISO 27001 e Equipe técnica qualificada. A proposta deve detalhar a metodologia de desenvolvimento, cronograma, equipe alocada, e plano de manutenção e suporte."
            },
            "gestao_contrato": {
                "modelo_gestao": "O modelo de gestão do contrato será baseado no acompanhamento e fiscalização contínuos da execução dos serviços, com reuniões periódicas para alinhamento e resolução de questões. Será nomeado um gestor e fiscais do contrato para monitorar o cumprimento das obrigações contratuais.",
                "papeis_responsabilidades": "O Gestor do Contrato será o responsável geral pelo acompanhamento, garantindo a conformidade e os resultados esperados. Os Fiscais do Contrato (administrativo e técnico) serão responsáveis pela verificação da execução dos serviços e pela atestação de qualidade e conformidade das entregas."
            },
            "criterios_pagamento": {
                "recebimento_objeto": "O recebimento do objeto será provisório no momento da conclusão de cada etapa de desenvolvimento/implantação e definitivo após a homologação e testes de aceitação, e cumprimento de todos os requisitos contratuais, no prazo máximo de 30 dias após o recebimento provisório.",
                "liquidacao": "A liquidação da despesa ocorrerá após o recebimento definitivo dos serviços, com a verificação do cumprimento das condições contratuais e legais.",
                "prazo_pagamento": "O prazo para pagamento será de até 5 (cinco) dias úteis contados da data de liquidação da despesa.",
                "forma_pagamento": "Ordem Bancária/SIAFI",
                "antecipacao_pagamento": false,
                "cessao_credito": "A cessão de crédito será admitida apenas nas condições expressamente previstas na Lei nº 14.133/2021 e demais regulamentos aplicáveis, mediante comunicação formal e anuência do Contratante."
            },
            "selecao_fornecedor": {
                "forma_selecao": "Pregão Eletrônico",
                "criterio_julgamento": "Menor Preço",
                "exigencias_habilitacao": {
                "juridica": [
                    "Registro comercial, no caso de empresa individual ou sociedade limitada.",
                    "Ato constitutivo, estatuto ou contrato social em vigor, devidamente registrado.",
                    "Decreto de autorização, em se tratando de empresa ou sociedade estrangeira em funcionamento no País.",
                    "Inscrição do ato constitutivo, no caso de sociedades civis, acompanhada de prova de diretoria em exercício."
                ],
                "fiscal_trabalhista": [
                    "Prova de inscrição no Cadastro Nacional de Pessoas Jurídicas (CNPJ).",
                    "Prova de regularidade para com a Fazenda Federal, Estadual e Municipal do domicílio ou sede do licitante.",
                    "Prova de regularidade para com o Fundo de Garantia do Tempo de Serviço (FGTS).",
                    "Prova de inexistência de débitos inadimplidos perante a Justiça do Trabalho, mediante a apresentação de certidão negativa."
                ],
                "economico_financeira": [
                    "Balanço patrimonial e demonstrações contábeis do último exercício social.",
                    "Certidão negativa de falência, recuperação judicial ou extrajudicial.",
                    "Capital social ou patrimônio líquido mínimo, conforme exigido no edital, para comprovar a capacidade financeira."
                ],
                "tecnica": [
                    "Comprovação de aptidão para desempenho de atividade pertinente e compatível em características, quantidades e prazos com o objeto da licitação, por meio de atestados ou declarações de capacidade técnica.",
                    "Apresentação de Certificação ISO 27001.",
                    "Indicação de equipe técnica qualificada para a execução dos serviços, com currículos e comprovação de experiência."
                ]
                }
            },
            "estimativa_valor": {
                "valor_total": "211000.0",
                "valor_unitario": null,
                "metodologia_pesquisa": "A estimativa de valor foi obtida por meio de pesquisa de mercado, consultando 5 empresas especializadas e utilizando fontes como ComprasNet e Painel de Preços, resultando em um preço médio de R$ 211.000,00 com variação de 15%."
            },
            "adequacao_orcamentaria": {
                "fonte_recursos": "[A SER DEFINIDO PELA UNIDADE ORÇAMENTÁRIA]",
                "classificacao_orcamentaria": "[A SER DEFINIDO PELA UNIDADE ORÇAMENTÁRIA]",
                "previsao_pca": true,
                "codigo_pca": "125"
            }
            }

        generatePdf(jsonData);
    });

    /**
     * Generates a PDF document from a JSON object using jsPDF.
     *
     * @param {object} jsonData The JSON data to populate the PDF.
     */
    function generatePdf(jsonData) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: "p", unit: "mm", format: "a4" });
        const pageWidth = doc.internal.pageSize.getWidth();
        const margin = 15;
        let y = 15; // Posição vertical inicial

        const subsectionIndent = 5; // Indentação para as subseções inteiras

        // Helper function for adding text with line wrapping
        const addWrappedText = (text, x, y, maxWidth) => {
            if (typeof text !== 'string') {
                text = String(text);
            }
            const lines = doc.splitTextToSize(text, maxWidth);
            doc.text(lines, x, y);
            return (lines.length * 6) + 2; // Approximate height of the text block + margin
        };
        
        // Helper for adding a numbered subsection with an optional title.
        // Handles text wrapping and vertical spacing.
        const addSubsection = (number, title, content, x, y, maxWidth) => {
            if (title) {
                doc.setFont("times", "bold");
                // If there is a title, the number and title are on the first line, bold.
                const fullText = `${number} ${title}`;
                doc.text(fullText, x, y);
                let currentY = y + 6; // Move down for the content
                
                doc.setFont("times", "normal");

                if (content && content.length > 0) {
                    const lines = doc.splitTextToSize(content, maxWidth);
                    doc.text(lines, x, currentY);
                    // Return total height used: title + content + margin
                    return 6 + (lines.length * 6) + 2;
                }
                // Return height for title only + margin
                return 6 + 2;
            } else {
                // If there is no title, number and content are on the same line.
                doc.setFont("times", "bold");
                const numberText = `${number} `;
                doc.text(numberText, x, y); // Draw bold number
                
                // Calculate width of the number to position the content correctly
                const numberWidth = doc.getStringUnitWidth(numberText) * doc.internal.getFontSize() / doc.internal.scaleFactor;
                
                doc.setFont("times", "normal");
                // Add the wrapped content next to the number
                const textHeight = addWrappedText(content, x + numberWidth, y, maxWidth - numberWidth);

                // Return the height of the content
                return textHeight;
            }
        };

        // Helper for adding numbered list items
        const addNumberedItem = (number, content, x, y, maxWidth) => {
            doc.setFont("times", "bold");
            const numberText = `${number} `;
            doc.text(numberText, x, y);
            
            const numberWidth = doc.getStringUnitWidth(numberText) * doc.internal.getFontSize() / doc.internal.scaleFactor;
            
            doc.setFont("times", "normal");
            const lines = doc.splitTextToSize(content, maxWidth - numberWidth);
            doc.text(lines, x + numberWidth, y);
            
            return (lines.length * 6) + 2;
        };

        // Function to check for new page
        const checkPageBreak = (heightNeeded) => {
            if (y + heightNeeded > 280) { // 297mm page height, with margin
                doc.addPage();
                y = 15;
            }
        };
        
        // Helper function for adding explanatory notes without background
        const addNotaExplicativa = (title, content) => {
            const contentWidth = pageWidth - margin * 2;
            
            doc.setFont("times", "bold");
            const titleLines = doc.splitTextToSize(title, contentWidth);
            const titleHeight = (titleLines.length * 6);
            
            doc.setFont("times", "normal");
            const contentLines = doc.splitTextToSize(content, contentWidth);
            const contentHeight = (contentLines.length * 6);

            const notaHeight = titleHeight + contentHeight - 5;

            checkPageBreak(notaHeight + 5);
            
            let currentY = y + 5;
            
            doc.setFont("times", "bold");
            doc.text(titleLines, margin, currentY);
            currentY += titleHeight;
            
            doc.setFont("times", "normal");
            doc.text(contentLines, margin, currentY);
            
            y += notaHeight;
        };

        const addContent = () => {
            const contentWidth = pageWidth - margin * 2;
            const sectionSpacing = 4;

            // Section 1: DA DEFINIÇÃO DO OBJETO
            checkPageBreak(20);
            doc.setFontSize(12);
            doc.setFont("times", "bold");
            doc.text("1. DA DEFINIÇÃO DO OBJETO", margin, y);
            y += 7;
            doc.setFontSize(11);
            doc.setFont("times", "normal");
            
            // Subseção 1.1
            y += addSubsection("1.1", "", jsonData.objeto_contratacao, margin + subsectionIndent, y, contentWidth - subsectionIndent);

            // Subseção 1.2
            checkPageBreak(30);
            y += addSubsection("1.2", "Detalhamento dos bens que compõem a solução:", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            const tableHeaders = ["Item/Grupo", "Descrição", "CATMAT", "Unidade", "Qtd", "V. Unit.", "V. Total"];
            const colWidths = [20, 50, 20, 20, 15, 20, 25];
            let currentX = margin + subsectionIndent;
            doc.setFont("times", "bold");
            tableHeaders.forEach((header, i) => {
                doc.rect(currentX, y, colWidths[i], 10);
                doc.text(header, currentX + 2, y + 6);
                currentX += colWidths[i];
            });
            doc.rect(margin + subsectionIndent, y + 10, contentWidth - subsectionIndent, 10);
            y += 25;
            doc.setFont("times", "normal");
            
            // Subseção 1.3
            checkPageBreak(15);
            y += addSubsection("1.3", "", "Os bens objeto desta contratação são caracterizados como comuns, conforme indicado no Estudo Técnico Preliminar.", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            
            // Subseção 1.4
            checkPageBreak(15);
            y += addSubsection("1.4", "", "Demais regras das condições e especificações da solução: [acrescentar outras se houve alterações em relação às indicada no Estudo Técnico Preliminar]", margin + subsectionIndent, y, contentWidth - subsectionIndent);

            // Subseção 1.5
            checkPageBreak(15);
            const prazoVigencia = `O prazo de vigência da contratação é de ${jsonData.prazo_vigencia_contrato}`;
            y += addSubsection("1.5", "", prazoVigencia, margin + subsectionIndent, y, contentWidth - subsectionIndent);
            
            // Subseção 1.6
            checkPageBreak(15);
            y += addSubsection("1.6", "", "O contrato oferece maior detalhamento das regras que serão aplicadas em relação à vigência da contratação.", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            
            y += sectionSpacing;
            
            // Section 2: DA FUNDAMENTAÇÃO E DESCRIÇÃO DA NECESSIDADE DA CONTRATAÇÃO
            checkPageBreak(40);
            doc.setFontSize(12);
            doc.setFont("times", "bold");
            doc.text("2. DA FUNDAMENTAÇÃO E DESCRIÇÃO DA NECESSIDADE DA CONTRATAÇÃO", margin, y);
            y += 7;
            doc.setFontSize(11);
            doc.setFont("times", "normal");
            y += addSubsection("2.1", "", jsonData.fundamentacao_legal, margin + subsectionIndent, y, contentWidth - subsectionIndent);
            
            let previsaoPCATexto;
            if (jsonData.adequacao_orcamentaria.previsao_pca === true) {
                const codigoPCA = jsonData.adequacao_orcamentaria.codigo_pca || "[não informado]";
                previsaoPCATexto = `O objeto da contratação está previsto no Plano de Contratações Anual (PCA), sob o código PCA ${codigoPCA}.`;
            } else {
                previsaoPCATexto = `O objeto da contratação não está previsto no Plano de Contratações Anual (PCA).`;
            }

            y += addSubsection("2.2", "", previsaoPCATexto, margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += sectionSpacing;

            y += sectionSpacing;    

            checkPageBreak(120);
            doc.setFont("times", "bold");
            doc.text("2.3 DO CABIMENTO DO SISTEMA DE REGISTRO DE PREÇOS", margin + subsectionIndent, y);
            y += 7;
            doc.setFont("times", "normal");

            const srpData = jsonData.sistema_registro_precos;
            const textIndent = margin + subsectionIndent + 5;
            const textWidth = contentWidth - subsectionIndent - 5;

            if (srpData.adota_srp) {
                // I
                y += addWrappedText(`I - Será adotado o Sistema de Registro de Preços (SRP) (art. 78, IV, Lei 14.133/2021) para a contratação pretendida.`, textIndent, y, textWidth);

                // II
                const quantidadeMaximaTexto = srpData.tem_quantidade_maxima
                    ? 'Será prevista uma quantidade máxima a ser adquirida para cada item/grupo, de acordo com o quadro que constará no edital.'
                    : 'Não haverá quantidade máxima a ser adquirida para cada item/grupo.';
                y += addWrappedText(`II - ${quantidadeMaximaTexto}`, textIndent, y, textWidth);

                // III
                const quantidadeMinimaTexto = srpData.tem_quantidade_minima
                    ? `A quantidade mínima de unidades de bens a serem cotadas será de ${srpData.quantidade_minima_cotacao} unidade(s).`
                    : 'Não se aplica a previsão de quantidade mínima de unidades de bens a serem cotadas.';
                y += addWrappedText(`III - ${quantidadeMinimaTexto}`, textIndent, y, textWidth);

                // IV
                const precosDiferentesTexto = srpData.permite_precos_diferentes
                    ? `Será permitida a previsão de preços diferentes. ${srpData.justificativa_precos_diferentes || '[justificativa não informada].'}`
                    : 'Não será permitida a previsão de preços diferentes.';
                y += addWrappedText(`IV - ${precosDiferentesTexto}`, textIndent, y, textWidth);

                // V
                const propostaInferiorTexto = srpData.permite_proposta_inferior
                    ? 'O licitante poderá oferecer proposta com quantitativo inferior ao máximo previsto.'
                    : `O licitante não poderá oferecer proposta com quantitativo inferior ao máximo previsto. Justificativa: ${srpData.justificativa_nao_proposta_inferior || '[justificativa não informada].'}`;
                y += addWrappedText(`V - ${propostaInferiorTexto}`, textIndent, y, textWidth);

                // VI
                const criterioJulgamentoTexto = srpData.criterio_julgamento === 'grupo'
                    ? 'Menor preço por Grupo de Itens.'
                    : 'Menor preço por Item.';
                y += addWrappedText(`VI - O critério de julgamento a ser adotado será o de ${criterioJulgamentoTexto}`, textIndent, y, textWidth);

                // VII
                const registroLimitadoTexto = srpData.registro_limitado
                    ? `Será permitido o registro de preços com indicação limitada a unidades de contratação porque ${srpData.justificativa_registro_limitado || '[justificativa não informada].'}`
                    : 'Não será permitido o registro de preços com indicação limitada a unidades de contratação.';
                y += addWrappedText(`VII - ${registroLimitadoTexto}`, textIndent, y, textWidth);

                // VIII
                y += addWrappedText(`VIII - Os preços registrados poderão ser objeto de reajustamento, observados os requisitos exigidos pela Lei n. 14.133, de 2021.`, textIndent, y, textWidth);

                // IX
                y += addWrappedText(`IX - Para fins de reajustamento, será adotado o seguinte critério: ${srpData.criterio_reajuste || '[Critério não definido].'}`, textIndent, y, textWidth);
                
                // X
                y += addWrappedText(`X - O prazo de vigência da ata de registro de preços será de ${srpData.vigencia_ata || '[Prazo não definido].'}`, textIndent, y, textWidth);
            } else {
                y += addWrappedText(`Não será adotado o Sistema de Registro de Preços. Justificativa: ${srpData.justificativa_srp || '[Justificativa não informada]'}`, textIndent, y, textWidth);
            }

            y += sectionSpacing;

            // Seção 3: DA DESCRIÇÃO DA SOLUÇÃO COMO UM TODO (ADICIONAR 3.1)
            checkPageBreak(30);
            doc.setFontSize(12);
            doc.setFont("times", "bold");

            const section3Title = "3. DA DESCRIÇÃO DA SOLUÇÃO COMO UM TODO CONSIDERADO O CICLO DE VIDA DO OBJETO E ESPECIFICAÇÃO DO PRODUTO";
            const titleHeight = addWrappedText(section3Title, margin, y, contentWidth);
            y += titleHeight;

            doc.setFontSize(11);
            doc.setFont("times", "normal");

            // ADICIONAR 3.1
            y += addSubsection("3.1", "", jsonData.descricao_solucao, margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += sectionSpacing;

            // Section 4: DOS REQUISITOS DA CONTRATAÇÃO
            checkPageBreak(60);
            doc.setFontSize(12);
            doc.setFont("times", "bold");
            doc.text("4. DOS REQUISITOS DA CONTRATAÇÃO", margin, y);
            y += 7;
            doc.setFontSize(11);
            doc.setFont("times", "normal");
            
            // ADICIONAR 4.1.1, 4.2.1, etc.
            y += addSubsection("4.1", "DA SUSTENTABILIDADE", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += addSubsection("4.1.1", "", jsonData.requisitos_contratacao.sustentabilidade, margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            
            y += addSubsection("4.2", "DA INDICAÇÃO DE MARCAS OU MODELOS", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += addSubsection("4.2.1", "", jsonData.requisitos_contratacao.indicacao_marcas, margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            
            y += addSubsection("4.3", "DA VEDAÇÃO DE UTILIZAÇÃO DE MARCA/PRODUTO", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += addSubsection("4.3.1", "", jsonData.requisitos_contratacao.vedacao_marca_produto, margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            
            y += addSubsection("4.4", "DA AMOSTRA", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += addSubsection("4.4.1", "", jsonData.requisitos_contratacao.exige_amostra ? 'Será exigida apresentação de amostra.' : 'Não será exigida apresentação de amostra.', margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            
            y += addSubsection("4.5", "DA CARTA DE SOLIDARIEDADE", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += addSubsection("4.5.1", "", jsonData.requisitos_contratacao.exige_carta_solidariedade ? 'Será exigida carta de solidariedade.' : 'Não será exigida carta de solidariedade.', margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            
            y += addSubsection("4.6", "DA SUBCONTRATAÇÃO", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += addSubsection("4.6.1", "", jsonData.admite_subcontratacao ? 'Admite-se subcontratação.' : 'Não se admite subcontratação.', margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            
            y += addSubsection("4.7", "DA GARANTIA DA CONTRATAÇÃO", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += addSubsection("4.7.1", "", jsonData.exige_garantia_contratual ? jsonData.requisitos_contratacao.garantia_produto_servico : 'Não se exige garantia contratual.', margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);

            y += sectionSpacing;

            // Section 5: DO MODELO DE EXECUÇÃO DO OBJETO
            checkPageBreak(100);
            doc.setFontSize(12);
            doc.setFont("times", "bold");
            doc.text("5. DO MODELO DE EXECUÇÃO DO OBJETO", margin, y);
            y += 7;
            doc.setFontSize(11);
            doc.setFont("times", "normal");
            y += addSubsection("5.1", "DAS CONDIÇÕES DE ENTREGA", jsonData.modelo_execucao.condicoes_entrega, margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += addSubsection("5.2", "DA GARANTIA, MANUTENÇÃO E ASSISTÊNCIA TÉCNICA", jsonData.modelo_execucao.garantia_manutencao, margin + subsectionIndent, y, contentWidth - subsectionIndent);
            
            // Subseção 5.3 com numeração
            checkPageBreak(15);
            y += addSubsection("5.3", "DOS DEVERES E RESPONSABILIDADES DO CONTRATANTE", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            jsonData.obrigacoes_contratante.forEach((item, index) => {
                checkPageBreak(10);
                y += addNumberedItem(`5.3.${index + 1}`, item, margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            });
            
            // Subseção 5.4 com numeração
            checkPageBreak(15);
            y += addSubsection("5.4", "DOS DEVERES E RESPONSABILIDADES DA CONTRATADA", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            jsonData.obrigacoes_contratada.forEach((item, index) => {
                checkPageBreak(10);
                y += addNumberedItem(`5.4.${index + 1}`, item, margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            });
            y += sectionSpacing;

            // Section 6: DO MODELO DE GESTÃO DO CONTRATO (ADICIONAR 6.1)
            checkPageBreak(20);
            doc.setFontSize(12);
            doc.setFont("times", "bold");
            doc.text("6. DO MODELO DE GESTÃO DO CONTRATO", margin, y);
            y += 7;
            doc.setFontSize(11);
            doc.setFont("times", "normal");
            
            // ADICIONAR 6.1
            y += addSubsection("6.1", "", jsonData.gestao_contrato.modelo_gestao, margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += sectionSpacing;
            
            // Section 7: DOS CRITÉRIOS DE PAGAMENTO
            checkPageBreak(50);
            doc.setFontSize(12);
            doc.setFont("times", "bold");
            doc.text("7. DOS CRITÉRIOS DE PAGAMENTO", margin, y);
            y += 7;
            doc.setFontSize(11);
            doc.setFont("times", "normal");
            
            // ADICIONAR 7.1.1, 7.2.1, etc.
            y += addSubsection("7.1", "DO RECEBIMENTO DO OBJETO", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += addSubsection("7.1.1", "", jsonData.criterios_pagamento.recebimento_objeto, margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            
            y += addSubsection("7.2", "DA LIQUIDAÇÃO", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += addSubsection("7.2.1", "", jsonData.criterios_pagamento.liquidacao, margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            
            y += addSubsection("7.3", "DO PRAZO DE PAGAMENTO", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += addSubsection("7.3.1", "", jsonData.criterios_pagamento.prazo_pagamento, margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            
            y += addSubsection("7.4", "DA FORMA DE PAGAMENTO", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += addSubsection("7.4.1", "", jsonData.criterios_pagamento.forma_pagamento, margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            
            y += addSubsection("7.5", "DA ANTECIPAÇÃO DE PAGAMENTO", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += addSubsection("7.5.1", "", jsonData.criterios_pagamento.antecipacao_pagamento ? 'Sim' : 'Não', margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            
            y += addSubsection("7.6", "DA CESSÃO DE CRÉDITO", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += addSubsection("7.6.1", "", jsonData.criterios_pagamento.cessao_credito, margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            
            y += sectionSpacing;

            // Section 8: DA FORMA E CRITÉRIO DE SELEÇÃO DO FORNECEDOR
            checkPageBreak(120);
            doc.setFontSize(12);
            doc.setFont("times", "bold");
            doc.text("8. DA FORMA E CRITÉRIO DE SELEÇÃO DO FORNECEDOR", margin, y);
            y += 7;
            doc.setFontSize(11);
            doc.setFont("times", "normal");
            
            // ADICIONAR 8.1.1
            y += addSubsection("8.1", "DA FORMA DE SELEÇÃO E CRITÉRIO DE JULGAMENTO DA PROPOSTA", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += addSubsection("8.1.1", "", `${jsonData.selecao_fornecedor.forma_selecao} - ${jsonData.selecao_fornecedor.criterio_julgamento}`, margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            
            // Subseção 8.2 com numeração
            checkPageBreak(15);
            y += addSubsection("8.2", "DAS EXIGÊNCIAS DE HABILITAÇÃO", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            
            // 8.2.1 - Jurídica
            y += addNumberedItem("8.2.1", "Jurídica:", margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            jsonData.selecao_fornecedor.exigencias_habilitacao.juridica.forEach((item) => {
                checkPageBreak(10);
                y += addWrappedText(`• ${item}`, margin + subsectionIndent + 10, y, contentWidth - subsectionIndent - 10);
            });
            
            // 8.2.2 - Fiscal e Trabalhista
            checkPageBreak(15);
            y += addNumberedItem("8.2.2", "Fiscal e Trabalhista:", margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            jsonData.selecao_fornecedor.exigencias_habilitacao.fiscal_trabalhista.forEach((item) => {
                checkPageBreak(10);
                y += addWrappedText(`• ${item}`, margin + subsectionIndent + 10, y, contentWidth - subsectionIndent - 10);
            });

            // 8.2.3 - Econômico-Financeira
            checkPageBreak(15);
            y += addNumberedItem("8.2.3", "Econômico-Financeira:", margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            jsonData.selecao_fornecedor.exigencias_habilitacao.economico_financeira.forEach((item) => {
                checkPageBreak(10);
                y += addWrappedText(`• ${item}`, margin + subsectionIndent + 10, y, contentWidth - subsectionIndent - 10);
            });

            // 8.2.4 - Técnica
            checkPageBreak(15);
            y += addNumberedItem("8.2.4", "Técnica:", margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            jsonData.selecao_fornecedor.exigencias_habilitacao.tecnica.forEach((item) => {
                checkPageBreak(10);
                y += addWrappedText(`• ${item}`, margin + subsectionIndent + 10, y, contentWidth - subsectionIndent - 10);
            });
            y += sectionSpacing;

            // Section 9: DA ESTIMATIVA DO VALOR DA CONTRATAÇÃO (ADICIONAR 9.1, 9.2, 9.3)
            checkPageBreak(30);
            doc.setFontSize(12);
            doc.setFont("times", "bold");
            doc.text("9. DA ESTIMATIVA DO VALOR DA CONTRATAÇÃO", margin, y);
            y += 7;
            doc.setFontSize(11);
            doc.setFont("times", "normal");
            
            // ADICIONAR 9.1, 9.2, 9.3
            y += addSubsection("9.1", "Valor Total:", `R$ ${jsonData.estimativa_valor.valor_total}`, margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += addSubsection("9.2", "Valor Unitário:", `R$ ${jsonData.estimativa_valor.valor_unitario}`, margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += addSubsection("9.3", "Metodologia da Pesquisa:", jsonData.estimativa_valor.metodologia_pesquisa, margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += sectionSpacing;

            // Section 10: DA ADEQUAÇÃO ORÇAMENTÁRIA (ADICIONAR 10.1, 10.2)
            checkPageBreak(20);
            doc.setFontSize(12);
            doc.setFont("times", "bold");
            doc.text("10. DA ADEQUAÇÃO ORÇAMENTÁRIA", margin, y);
            y += 7;
            doc.setFontSize(11);
            doc.setFont("times", "normal");
            
            // ADICIONAR 10.1, 10.2
            y += addSubsection("10.1", "Fonte de Recursos:", jsonData.adequacao_orcamentaria.fonte_recursos, margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += addSubsection("10.2", "Classificação Orçamentária:", jsonData.adequacao_orcamentaria.classificacao_orcamentaria, margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += sectionSpacing;

            // Section 11: DAS INFRAÇÕES E SANÇÕES APLICÁVEIS (ADICIONAR 11.1)
            checkPageBreak(20);
            doc.setFontSize(12);
            doc.setFont("times", "bold");
            doc.text("11. DAS INFRAÇÕES E SANÇÕES APLICÁVEIS", margin, y);
            y += 7;
            doc.setFontSize(11);
            doc.setFont("times", "normal");
            
            // ADICIONAR 11.1
            y += addSubsection("11.1", "", jsonData.sancoes_administrativas, margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += 20;

            // Signature
            checkPageBreak(20);
            doc.text("________________________________________", pageWidth / 2, y, { align: "center" });
            y += 7;
            doc.text(jsonData.responsavel, pageWidth / 2, y, { align: "center" });
            y += 5;
            doc.text(jsonData.cargo_responsavel, pageWidth / 2, y, { align: "center" });
        }

        const addHeaderAndSave = () => {
            const brasaoImg = new Image();
            brasaoImg.src = "/static/assets/img/brasao_oficial_republica.png";

            const drawContentAndSave = () => {
                doc.setFontSize(9);
                doc.setFont("times", "normal");
                doc.text("TRIBUNAL REGIONAL ELEITORAL DO ACRE", pageWidth / 2, y, { align: "center" });
                y += 10;

                doc.setFontSize(8);
                doc.text("Alameda Ministro Miguel Ferrante, 224 - Bairro Portal da Amazônia - CEP 69915-632 - Rio Branco - AC", pageWidth / 2, y, { align: "center" });
                y += 10;

                doc.setFontSize(11);
                doc.text("ANEXO VIII", pageWidth / 2, y, { align: "center" });
                y += 15;

                doc.setFontSize(11);
                doc.setFont("times", "bold");
                doc.text("TERMO DE REFERÊNCIA (TR) PARA COMPRAS", pageWidth / 2, y, { align: "center" });
                y += 15;

                doc.setFontSize(11);
                doc.setFont("times", "bold");
                doc.text("TERMO DE REFERÊNCIA", pageWidth / 2, y, { align: "center" });
                y += 15;

                addContent();
                doc.save("Termo_de_Referencia.pdf");
            };

            brasaoImg.onload = () => {
                const targetWidth = 40;
                const aspectRatio = brasaoImg.height / brasaoImg.width;
                const targetHeight = targetWidth * aspectRatio;
                const xPosition = pageWidth / 2 - targetWidth / 2;

                y = 15;

                doc.addImage(brasaoImg, "PNG", xPosition, y, targetWidth, targetHeight);
                y += targetHeight + 10;

                drawContentAndSave();
            };

            brasaoImg.onerror = () => {
                console.error("Falha ao carregar imagem do brasão.");
                y = 15; // Reset Y position if image fails
                y += 40; // Approximate space for the missing image
                drawContentAndSave();
            };
        };

        addHeaderAndSave();
    }
</script>

</body>
</html>