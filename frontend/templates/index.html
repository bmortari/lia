<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet" />
    <title>LIA - Licita√ß√µes com IA</title>
    <style>
        :root {
          --background-color: #F0F0F0;
        }

        body {
          background-color: var(--background-color);
          margin: 0;
          padding: 0;
        }

        .background-waves {
            position: fixed;
            left: 0;
            top: 0;
            width: 300px;
            height: 100vh;
            background-image: url('/static/assets/img/abstract.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            z-index: -1;
        }
        
        .content-wrapper {
            margin-left: 300px;
            min-height: 100vh;
        }

        .btn-custom {
            background-color: #0097B2;
        }

        .btn-custom:hover {
            background-color: #007d96;
        }

        .btn-custom:focus {
            box-shadow: 0 0 0 4px rgba(0, 151, 178, 0.3);
        }

        .btn-manual {
            background-color: #919297;
            color: white;
            border: none;
        }

        .btn-manual:hover {
            background-color: #7a7d82;
        }

        .btn-manual:focus {
            box-shadow: 0 0 0 4px rgba(145, 146, 151, 0.3);
        }

        .btn-demo {
            background-color: #28a745;
            color: white;
            border: none;
        }

        .btn-demo:hover {
            background-color: #218838;
        }

        .btn-demo:focus {
            box-shadow: 0 0 0 4px rgba(40, 167, 69, 0.3);
        }

        .btn-demo:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .container-projetos {
            border: 2px solid #0097B2;
            height: 580px;
            max-height: 580px;
            flex-shrink: 0;
        }

        #lista-projetos {
            max-height: 420px;
            overflow-y: auto;
        }

        .credits-section {
            margin-top: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .credits-text {
            color: #000;
            font-size: 18px;
            font-weight: 500;
            margin: 0;
        }

        .credits-section img {
            height: 40px;
            width: auto;
            object-fit: contain;
        }

        .credits-section #logo-nativa {
            height: 100px;
            width: auto;
            object-fit: contain;
        }

        .grid-wrapper {
            align-items: flex-start;
            max-height: 100vh;
        }

        .container-introducao {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 580px;
        }

        /* Estilos para notifica√ß√µes */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            max-width: 400px;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 14px;
            line-height: 1.4;
        }

        .notification.success {
            background-color: #28a745;
        }

        .notification.error {
            background-color: #dc3545;
        }

        .notification.info {
            background-color: #17a2b8;
        }

        .notification.warning {
            background-color: #ffc107;
            color: #212529;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        /* Loading animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }
      
        /* Debug info */
        .debug-info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-family: monospace;
            z-index: 999;
            max-width: 300px;
        }

        .debug-commands {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #555;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <!-- Elemento para a imagem de fundo -->
    <div class="background-waves"></div>
    
    <main class="content-wrapper">
        <div class="layout-wrapper h-screen flex items-center justify-center">
            <div class="grid-wrapper grid grid-cols-2 gap-8 items-start">
                <div class="container-introducao p-4">
                    <div>
                        <div class="mb-6 w-128">
                         <img src="/static/assets/img/logo_lia.png" alt="LIA - Licita√ß√µes com IA" class="h-30 w-auto pb-8">
                        </div>
                        <p class="text-2xl w-128 max-w-xl mb-6 pb-8">
                          O LIA √© a plataforma que simplifica a gera√ß√£o de documentos licitat√≥rios. Mais efici√™ncia. Mais seguran√ßa. Mais inova√ß√£o.
                        </p>
                        <div class="btn-group mb-8">
                            <button type="button" class="btn-manual cursor-pointer font-medium rounded-lg text-sm px-5 py-2.5 focus:outline-none">
                                Manual
                            </button>
                            <button type="button" id="iniciar_projeto" class="btn-custom cursor-pointer text-white font-medium rounded-lg text-sm px-5 py-2.5 focus:outline-none">
                                Iniciar projeto
                            </button>
                            <button type="button" id="carregar_dados_demo" class="btn-demo cursor-pointer font-medium rounded-lg text-sm px-4 py-2.5 focus:outline-none">
                                <span id="demo-btn-text">üì¶ Dados Demo</span>
                                <span id="demo-loading" class="hidden">
                                    <span class="loading-spinner"></span>Carregando...
                                </span>
                            </button>
                        </div>
                        
                        <!-- Info para desenvolvedores -->
                        <div class="debug-info" id="debug-info" style="display: none;">
                            <div>
                                <strong>Debug Info:</strong><br>
                                Ctrl+Shift+V: Verificar arquivo seed<br>
                                Ctrl+Shift+C: Verificar comandos SQL
                            </div>
                            <div class="debug-commands" id="debug-commands" style="display: none;">
                                <!-- Comandos SQL ser√£o mostrados aqui -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Se√ß√£o de cr√©ditos -->
                    <div class="credits-section">
                        <p class="credits-text">DESENVOLVIDO POR:</p>
                        <img src="/static/assets/img/logo_tre.png" alt="Logo 1">
                        <img src="/static/assets/img/logo_nativa.png" alt="Logo 2" id="logo-nativa">
                    </div>
                </div>
                <div class="container-projetos w-full max-w-sm p-4 bg-white border border-gray-200 rounded-lg shadow-sm sm:p-6 flex flex-col">
                    <div class="flex-shrink-0">
                        <h5 class="mb-3 text-base font-semibold text-gray-900 md:text-xl">
                            Projetos recentes
                        </h5>
                        <p class="text-sm font-normal text-gray-500 mb-4">
                            Selecione um dos projetos recentes para acessar os servi√ßos:
                        </p>
                    </div>
                    <ul id="lista-projetos" class="space-y-3 gap-2 flex-grow">
                        <!-- Itens do projeto ser√£o inseridos aqui dinamicamente -->
                        <li class="text-gray-500 text-center py-4">
                            <div class="loading-spinner" style="border-color: #6b7280; border-top-color: transparent; margin: 0 auto 8px;"></div>
                            Carregando projetos...
                        </li>
                    </ul>
                    <div class="text-center mt-4 flex-shrink-0">
                        <a href="listar_projetos" class="inline-flex items-center text-sm font-normal text-gray-500 hover:underline">
                            Ver todos os projetos
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>
    <script>
        // Vari√°vel global para armazenar info de debug
        let debugInfo = {};

        // Mostrar debug info em desenvolvimento
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            document.getElementById('debug-info').style.display = 'block';
        }

        // Fun√ß√£o para mostrar notifica√ß√µes melhorada
        function showNotification(message, type = 'info', duration = 5000) {
            // Remover notifica√ß√µes existentes
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(n => n.remove());

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = message;
            document.body.appendChild(notification);

            console.log(`[${type.toUpperCase()}] ${message.replace(/<br>/g, ' | ')}`);

            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, duration);
        }

        // Fun√ß√£o para carregar projetos
        async function loadProjects() {
            const url = window.location.origin;
            const projectList = document.getElementById('lista-projetos');

            const formatDate = (dateString) => {
                const date = new Date(dateString);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                return `${day}/${month}`;
            };

            try {
                const response = await fetch(`${url}/projetos/?limit=15`, {
                    method: 'GET',
                    headers: {
                        'accept': 'application/json',
                        'remote-user': 'user.test',
                        'remote-groups': 'TI,OUTROS'
                    }
                });

                if (!response.ok) {
                    throw new Error('Erro ao buscar projetos');
                }

                const projects = await response.json();
                projectList.innerHTML = '';

                console.log(`üìä Projetos carregados: ${projects.length}`);

                if (projects.length === 0) {
                    projectList.innerHTML = '<li class="text-gray-500 text-center py-4">Nenhum projeto encontrado.<br><small>Clique em "Dados Demo" para carregar exemplos</small></li>';
                    return;
                }

                projects.sort((a, b) => new Date(b.dt_created) - new Date(a.dt_created));

                projects.forEach(project => {
                    const listItem = document.createElement('li');
                    listItem.className = 'flex flex-col';
                    listItem.innerHTML = `
                        <p class="pl-5 text-sm text-gray-500 mb-1">${formatDate(project.dt_created)}</p>
                        <a href="${url}/projetos/${project.id_projeto}/" class="flex items-center p-3 text-base font-bold text-gray-900 rounded-lg bg-gray-50 hover:bg-gray-100 group hover:shadow dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-white">
                            <span class="flex-1 ms-3 whitespace-nowrap"> ${project.nome}</span>
                        </a>
                    `;
                    projectList.appendChild(listItem);
                });

            } catch (error) {
                console.error('‚ùå Falha ao carregar projetos:', error);
                projectList.innerHTML = '<li class="text-red-500 text-center py-4">N√£o foi poss√≠vel carregar os projetos.</li>';
            }
        }

        // Fun√ß√£o melhorada para verificar arquivo seed
        async function verificarArquivoSeed() {
            const url = window.location.origin;
            try {
                console.log('üîç Verificando arquivo seed...');
                
                const response = await fetch(`${url}/verificar-arquivo-seed`, {
                    method: 'GET',
                    headers: {
                        'accept': 'application/json',
                        'remote-user': 'user.test',
                        'remote-groups': 'TI,OUTROS'
                    }
                });

                if (!response.ok) {
                    throw new Error('Erro ao verificar arquivo seed');
                }

                const result = await response.json();
                debugInfo = result;
                console.log('üìÑ Info do arquivo seed:', result);
                
                if (!result.arquivo_existe) {
                    showNotification('‚ùå Arquivo seed_example.sql n√£o encontrado!', 'error');
                    return false;
                }
                
                if (result.tamanho_bytes === 0) {
                    showNotification('‚ö†Ô∏è Arquivo seed_example.sql est√° vazio!', 'warning');
                    return false;
                }

                const infoMsg = [
                    `‚úÖ Arquivo encontrado`,
                    `üìè Tamanho: ${result.tamanho_bytes} bytes`,
                    `üõ†Ô∏è Comandos SQL: ${result.total_comandos_sql || 0}`
                ].join('<br>');
                
                showNotification(infoMsg, 'info', 4000);

                // Mostrar comandos SQL no debug se dispon√≠vel
                if (result.comandos_preview && result.comandos_preview.length > 0) {
                    const debugCommands = document.getElementById('debug-commands');
                    debugCommands.innerHTML = `
                        <strong>Comandos SQL encontrados (${result.total_comandos_sql}):</strong><br>
                        ${result.comandos_preview.map((cmd, i) => `${i+1}. ${cmd}`).join('<br>')}
                    `;
                    debugCommands.style.display = 'block';
                }
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Erro ao verificar arquivo seed:', error);
                showNotification(`‚ùå Erro ao verificar arquivo: ${error.message}`, 'error');
                return false;
            }
        }

        // Fun√ß√£o melhorada para carregar dados demo
        async function loadDemoData() {
            const url = window.location.origin;
            const demoBtn = document.getElementById('carregar_dados_demo');
            const btnText = document.getElementById('demo-btn-text');
            const loadingText = document.getElementById('demo-loading');

            console.log('üöÄ Iniciando carregamento de dados demo...');

            // Primeiro, verificar se o arquivo existe
            const arquivoOk = await verificarArquivoSeed();
            if (!arquivoOk) {
                console.log('‚ùå Arquivo seed n√£o est√° OK, cancelando carregamento');
                return;
            }

            // Desabilitar bot√£o e mostrar loading
            demoBtn.disabled = true;
            btnText.classList.add('hidden');
            loadingText.classList.remove('hidden');

            try {
                console.log('üì° Enviando requisi√ß√£o para popular dados...');
                
                const response = await fetch(`${url}/popular-dados-demo`, {
                    method: 'POST',
                    headers: {
                        'accept': 'application/json',
                        'remote-user': 'user.test',
                        'remote-groups': 'TI,OUTROS'
                    }
                });

                const result = await response.json();
                console.log('üìä Resultado do carregamento:', result);

                if (!response.ok) {
                    throw new Error(result.detail || 'Erro ao carregar dados demo');
                }

                if (result.status === 'ja_populado') {
                    showNotification(`‚ÑπÔ∏è ${result.message} (${result.projetos_existentes} projetos)`, 'info');
                } else {
                    const detalhes = [
                        `‚úÖ ${result.message}`,
                        `üìä Projetos: ${result.total_projetos}`,
                        `üìù Comandos executados: ${result.comandos_executados}`,
                        result.insert_commands ? `‚ûï INSERTs: ${result.insert_commands}` : '',
                        result.update_commands ? `üîÑ UPDATEs: ${result.update_commands}` : '',
                        result.delete_commands ? `üóëÔ∏è DELETEs: ${result.delete_commands}` : ''
                    ].filter(Boolean).join('<br>');
                    
                    showNotification(detalhes, 'success', 8000);
                }
                
                // Recarregar a lista de projetos
                console.log('üîÑ Recarregando lista de projetos...');
                setTimeout(async () => {
                    await loadProjects();
                }, 1000);

            } catch (error) {
                console.error('‚ùå Erro ao carregar dados demo:', error);
                showNotification(`‚ùå Erro: ${error.message}`, 'error');
            } finally {
                // Reabilitar bot√£o
                demoBtn.disabled = false;
                btnText.classList.remove('hidden');
                loadingText.classList.add('hidden');
            }
        }

        // Fun√ß√£o para limpar dados demo (para debug)
        async function limparDadosDemo() {
            if (!confirm('Tem certeza que deseja limpar todos os dados demo?')) {
                return;
            }
            
            const url = window.location.origin;
            try {
                console.log('üóëÔ∏è Limpando dados demo...');
                
                const response = await fetch(`${url}/limpar-dados-demo`, {
                    method: 'DELETE',
                    headers: {
                        'accept': 'application/json',
                        'remote-user': 'user.test',
                        'remote-groups': 'TI,OUTROS'
                    }
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.detail || 'Erro ao limpar dados demo');
                }

                console.log('‚úÖ Dados limpos:', result);
                showNotification('üóëÔ∏è Dados demo limpos com sucesso!', 'success');
                await loadProjects();

            } catch (error) {
                console.error('‚ùå Erro ao limpar dados demo:', error);
                showNotification(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Aplica√ß√£o iniciada');
            
            // Carregar projetos inicialmente
            await loadProjects();

            // Event listener para iniciar projeto
            const iniciarBtn = document.getElementById('iniciar_projeto');
            if (iniciarBtn) {
                iniciarBtn.addEventListener('click', () => {
                    let baseUrl = window.location.href.split('#')[0];
                    const url = new URL(baseUrl);
                    url.pathname = url.pathname.endsWith('/') 
                        ? url.pathname + 'criar_projeto'
                        : url.pathname + '/criar_projeto';
                    window.location.href = url.href;
                });
            }

            // Event listener para carregar dados demo
            const demoBtn = document.getElementById('carregar_dados_demo');
            if (demoBtn) {
                demoBtn.addEventListener('click', loadDemoData);
            }

            // Adicionar bot√£o de debug para limpar dados (apenas em desenvolvimento)
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                const debugBtn = document.createElement('button');
                debugBtn.innerHTML = 'üóëÔ∏è Limpar Demo';
                debugBtn.className = 'btn-demo cursor-pointer font-medium rounded-lg text-sm px-4 py-2.5 focus:outline-none';
                debugBtn.style.backgroundColor = '#dc3545';
                debugBtn.addEventListener('click', limparDadosDemo);
                
                const btnGroup = document.querySelector('.btn-group');
                if (btnGroup) {
                    btnGroup.appendChild(debugBtn);
                }
            }

            // Event listeners para debug
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.shiftKey) {
                    if (e.key === 'V') {
                        e.preventDefault();
                        verificarArquivoSeed();
                    } else if (e.key === 'C') {
                        e.preventDefault();
                        console.log('üêõ Debug Info:', debugInfo);
                        if (debugInfo.comandos_preview) {
                            console.log('üìù Comandos SQL:', debugInfo.comandos_preview);
                        }
                    }
                }
            });

            console.log('‚úÖ Aplica√ß√£o carregada com sucesso');
        });
    </script>
</body>
</html>