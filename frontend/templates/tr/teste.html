<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Geração de PDF com jsPDF</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f4f4f9;
        }
        h1 {
            color: #333;
        }
        button {
            padding: 15px 30px;
            font-size: 16px;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>

    <h1>Teste de Geração de PDF</h1>
    <p>Clique no botão abaixo para gerar e baixar o "Termo de Referência" em PDF.</p>
    <button id="generate-pdf-btn">Gerar PDF</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
    // Adiciona o evento de clique ao botão
    document.getElementById('generate-pdf-btn').addEventListener('click', () => {
        // JSON com os dados para o template
        const jsonData = {
        "id": 13,
        "id_projeto": 4,
        "user_created": "teste",
        "data_created": "2025-09-09T20:38:19.026110Z",
        "orgao_contratante": "Tribunal Regional Eleitoral do Acre",
        "tipo_contratacao": "compras",
        "objeto_contratacao": "Contratação de motocicleta para transporte de servidores públicos, visando otimizar o deslocamento e agilizar as atividades administrativas.",
        "modalidade_licitacao": "aquisicao_direta",
        "fundamentacao_legal": "A presente contratação encontra fundamento no Art. 40 da Lei nº 14.133, de 2021, e nas informações detalhadas no Estudo Técnico Preliminar e demais documentos anexos a este processo.",
        "descricao_solucao": "A solução consiste na aquisição de motocicleta para transporte de servidores públicos, visando otimizar o deslocamento e agilizar as atividades administrativas, atendendo à necessidade de um meio de transporte ágil e eficiente para os servidores públicos. A motocicleta será utilizada para o deslocamento entre diferentes unidades administrativas, para a realização de serviços externos e para o atendimento de demandas urgentes. Deverá ser entregue conforme as especificações técnicas detalhadas no item deste Termo de Referência e no Estudo Técnico Preliminar.",
        "prazo_vigencia_contrato": "O prazo de vigência da contratação será o necessário para a entrega do objeto e adoção das providências contratuais, conforme o Art. 105 da Lei nº 14.133, de 2021. Estima-se 90 (noventa) dias contados da assinatura do contrato.",
        "prazo_entrega_prestacao": "30 (trinta) dias úteis após a assinatura do contrato ou recebimento da Ordem de Fornecimento.",
        "local_entrega_prestacao": "Tribunal Regional Eleitoral do Acre, [ENDEREÇO COMPLETO A SER ESPECIFICADO NO EDITAL].",
        "obrigacoes_contratante": [
            "Efetuar o pagamento nos prazos e condições estabelecidas em contrato.",
            "Prestar as informações e esclarecimentos necessários para a execução contratual.",
            "Designar fiscal(is) para acompanhar e fiscalizar a execução do contrato.",
            "Receber o objeto nos termos e condições estabelecidas neste Termo de Referência e no contrato."
        ],
        "obrigacoes_contratada": [
            "Entregar o objeto conforme as especificações técnicas, prazos e locais estabelecidos.",
            "Garantir a qualidade do bem fornecido, responsabilizando-se por vícios e defeitos.",
            "Manter todas as condições de habilitação e qualificação exigidas durante toda a execução do contrato.",
            "Assumir a responsabilidade por todos os encargos fiscais, comerciais, sociais e trabalhistas decorrentes da contratação."
        ],
        "admite_subcontratacao": false,
        "exige_garantia_contratual": true,
        "condicoes_pagamento": "O pagamento será efetuado após o recebimento definitivo do objeto, mediante apresentação da nota fiscal ou documento equivalente, devidamente atestados pelo fiscal do contrato, em até [DEFINIR PRAZO, EX: 5 dias úteis] após a liquidação da despesa.",
        "sancoes_administrativas": "As sanções administrativas aplicáveis à Contratada serão aquelas previstas na Lei nº 14.133/2021 (Capítulo IX, Arts. 155 a 163), no edital e no contrato, incluindo advertência, multa, impedimento de licitar e contratar com a Administração Pública e declaração de inidoneidade.",
        "responsavel": "Vinicius Santos Machado",
        "cargo_responsavel": "[CARGO DO RESPONSÁVEL]",
        "sistema_registro_precos": {
            "adota_srp": false,
            "tipo_srp": null,
            "quantidade_maxima": false,
            "quantidade_minima_cotacao": null,
            "permite_precos_diferentes": false,
            "justificativa_precos_diferentes": null,
            "permite_proposta_inferior": false,
            "criterio_julgamento": null,
            "registro_limitado": false,
            "criterio_reajuste": null,
            "vigencia_ata": null
        },
        "requisitos_contratacao": {
            "sustentabilidade": "Serão adotadas medidas para mitigar impactos ambientais, priorizando modelos de motocicleta com menor emissão de gases poluentes e maior eficiência energética, incentivando o uso de combustíveis renováveis, realizando manutenções preventivas e garantindo o descarte adequado de peças. Além disso, a contratação deverá estar alinhada ao Plano de Logística Sustentável (PLS) da Administração Pública, priorizando fornecedores que adotem práticas de sustentabilidade e utilizem materiais e componentes reciclados ou de origem renovável.",
            "indicacao_marcas": "Não há indicação de marcas ou modelos específicos, visando ampla competitividade e conformidade com a Lei nº 14.133/2021, priorizando a adequação às especificações técnicas e o menor custo total de propriedade.",
            "vedacao_marca_produto": "Não há vedação à utilização de qualquer marca ou produto, desde que atenda integralmente às especificações técnicas e de desempenho exigidas no edital e neste Termo de Referência.",
            "exige_amostra": false,
            "exige_carta_solidariedade": false,
            "garantia_produto_servico": "Garantia mínima de 12 (doze) meses contra defeitos de fabricação, com exigência de garantia estendida e ampla rede de assistência técnica, conforme o Plano de Gerenciamento de Riscos (PGR) para garantir a disponibilidade e a continuidade dos serviços.",
            "exige_vistoria": false
        },
        "modelo_execucao": {
            "condicoes_entrega": "A entrega da motocicleta deverá ocorrer no local indicado pelo Contratante, em condições de uso imediato, acompanhada de toda a documentação legal (nota fiscal, manual, chave reserva, certificado de garantia e documentação de licenciamento/emplacamento, se aplicável). A entrega deverá ser precedida de comunicação formal e agendamento.",
            "garantia_manutencao": "O fornecedor deverá oferecer garantia mínima de 12 (doze) meses. Será avaliada a possibilidade de contratação de serviço de manutenção preventiva e corretiva, ou a inclusão de cláusulas robustas de manutenção e SLA (Service Level Agreement) no contrato de aquisição, conforme as recomendações do Plano de Gerenciamento de Riscos.",
            "materiais_fornecidos": "A Contratada deverá fornecer a motocicleta completa, nova, zero quilômetro, com todos os equipamentos e acessórios necessários para o seu funcionamento e segurança, conforme especificações técnicas detalhadas.",
            "informacoes_proposta": "As propostas deverão conter as especificações técnicas detalhadas da motocicleta ofertada, comprovando o atendimento a todos os requisitos mínimos estabelecidos no Termo de Referência, além da proposta de preços e da documentação de habilitação exigida. Devem também apresentar comprovação de homologação e certificações de segurança e durabilidade."
        },
        "gestao_contrato": {
            "modelo_gestao": "A gestão e fiscalização do contrato serão realizadas por servidor(es) designado(s) pela Administração, que acompanhará(ão) o cumprimento das especificações, prazos e condições contratuais. O monitoramento será contínuo, com revisões formais periódicas e relatórios de desempenho, conforme as diretrizes do Plano de Gerenciamento de Riscos.",
            "papeis_responsabilidades": "O Gestor do Contrato será o responsável geral pela coordenação das atividades de fiscalização e pelo acompanhamento da execução, enquanto o Fiscal Técnico será o encarregado da verificação do cumprimento das especificações técnicas do objeto e da qualidade do bem entregue. Ambos atuarão em conformidade com o Manual de Gestão e Fiscalização de Contratos do TRE-AC."
        },
        "criterios_pagamento": {
            "recebimento_objeto": "O recebimento do objeto será realizado em duas etapas: provisório, pelo fiscal do contrato, mediante termo circunstanciado, para verificação inicial; e definitivo, após a verificação da conformidade completa com as especificações e a aprovação pela área técnica, em até 5 (cinco) dias úteis após o recebimento provisório.",
            "liquidacao": "A liquidação da despesa ocorrerá após o recebimento definitivo do objeto e a apresentação da nota fiscal ou documento equivalente, devidamente atestados pelo fiscal do contrato e aprovados pela área responsável.",
            "prazo_pagamento": "O pagamento será efetuado em até [DEFINIR PRAZO, EX: 5 dias úteis] após a liquidação da despesa, mediante crédito em conta corrente da Contratada.",
            "forma_pagamento": "Ordem Bancária/SIAFI",
            "antecipacao_pagamento": false,
            "cessao_credito": "A cessão de crédito pela Contratada deverá obedecer às disposições legais pertinentes e às condições estabelecidas em contrato, mediante prévia e expressa anuência da Contratante."
        },
        "selecao_fornecedor": {
            "forma_selecao": "Pregão Eletrônico",
            "criterio_julgamento": "Menor Preço por Item",
            "exigencias_habilitacao": {
            "juridica": [
                "Ato constitutivo, estatuto ou contrato social em vigor, devidamente registrado;",
                "Decreto de autorização, em se tratando de empresa ou sociedade estrangeira em funcionamento no País, e ato de registro ou autorização para funcionamento, expedido pelo órgão competente, quando a atividade assim o exigir."
            ],
            "fiscal_trabalhista": [
                "Comprovação de regularidade fiscal perante a Fazenda Federal, Estadual e Municipal do domicílio ou sede do licitante;",
                "Comprovação de regularidade para com o Fundo de Garantia do Tempo de Serviço (FGTS);",
                "Comprovação de regularidade para com a Justiça do Trabalho."
            ],
            "economico_financeira": [
                "Balanço patrimonial e demonstrações contábeis do último exercício social, que comprovem boa situação financeira;",
                "Certidão negativa de falência, recuperação judicial ou extrajudicial, expedida pelo distribuidor da sede da pessoa jurídica."
            ],
            "tecnica": [
                "Atestados de capacidade técnica, emitidos por pessoas jurídicas de direito público ou privado, que comprovem a experiência da licitante no fornecimento de motocicletas similares, em características e quantidades compatíveis com o objeto desta contratação;",
                "Certificações de qualidade do fabricante da motocicleta, atestando a conformidade com as normas técnicas e de segurança vigentes (Ex: INMETRO, CONTRAN);",
                "Declaração do fabricante ou de seu representante legal de que a motocicleta possui garantia e rede de assistência técnica no território nacional."
            ]
            }
        },
        "estimativa_valor": {
            "valor_total": "42662.17",
            "valor_unitario": "42662.17",
            "metodologia_pesquisa": "A estimativa de valor foi baseada em pesquisa de mercado realizada com dados de contratos similares, atas de registro de preços e consulta direta a fornecedores, incluindo o Painel de Preços e dados históricos. Foi identificada uma variação percentual de até 30% nos preços pesquisados, buscando os valores mais competitivos e a garantia da qualidade."
        },
        "adequacao_orcamentaria": {
            "fonte_recursos": "[DEFINIR FONTE DE RECURSOS ORÇAMENTÁRIOS]",
            "classificacao_orcamentaria": "[DEFINIR CLASSIFICAÇÃO ORÇAMENTÁRIA - EX: 44.90.52 - Equipamentos e Material Permanente]",
            "previsao_pca": false,
            "codigo_pca": null
        },
        "itens": [
            {
            "descricao": "Motocicleta para transporte de servidores públicos, conforme especificações detalhadas no item de solução do Estudo Técnico Preliminar e neste Termo de Referência.",
            "especificacoes_tecnicas": [
                "Motor 4 tempos, arrefecido a ar, com cilindrada não inferior a 150cc e potência não inferior a 14cv;",
                "Sistema de partida elétrica e injeção eletrônica;",
                "Transmissão de cinco velocidades;",
                "Freios a disco nas duas rodas com sistema ABS;",
                "Painel de instrumentos digital completo;",
                "Suspensão dianteira telescópica e traseira monoamortecida;",
                "Pneus de uso misto (on/off road);",
                "Capacidade do tanque de combustível de no mínimo 12 litros;",
                "Farol e lanterna traseira em LED;",
                "Protetor de motor e carenagem;",
                "Bauleto traseiro com capacidade mínima de 30 litros."
            ],
            "quantidade": "1.000",
            "valor_unitario": "42662.17",
            "valor_total": "42662.17000",
            "unidade_medida": "Unidade",
            "codigo_catmat_catser": "[A DEFINIR CATMAT]",
            "finalidade": "Transporte ágil e eficiente de servidores públicos entre diferentes locais de trabalho, para realização de serviços externos e atendimento de demandas urgentes, otimizando o deslocamento e agilizando as atividades administrativas do Tribunal Regional Eleitoral do Acre."
            },
            {
                "descricao": "Capacete de segurança para motociclista, modelo fechado (integral), com viseira antirrisco e sistema de ventilação.",
                "especificacoes_tecnicas": [ "Certificação pelo INMETRO.", "Casco em resina termoplástica ABS.", "Forro removível e lavável." ],
                "quantidade": "2.000",
                "valor_unitario": "450.00",
                "valor_total": "900.00000",
                "unidade_medida": "Unidade",
                "codigo_catmat_catser": "[A DEFINIR CATMAT]",
                "finalidade": "Garantir a segurança do servidor público durante o deslocamento."
            },
            {
                "descricao": "Jaqueta de proteção para motociclista, confeccionada em tecido de alta resistência à abrasão, com proteções internas.",
                "especificacoes_tecnicas": [ "Tecido poliéster 600D.", "Proteções removíveis nos ombros e cotovelos.", "Faixas refletivas." ],
                "quantidade": "2.000",
                "valor_unitario": "600.00",
                "valor_total": "1200.00000",
                "unidade_medida": "Unidade",
                "codigo_catmat_catser": "[A DEFINIR CATMAT]",
                "finalidade": "Prover proteção contra intempéries e em caso de queda."
            }
        ]
        }

        generatePdf(jsonData);
    });

    /**
     * Generates a PDF document from a JSON object using jsPDF.
     *
     * @param {object} jsonData The JSON data to populate the PDF.
     */
    function generatePdf(jsonData) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: "p", unit: "mm", format: "a4" });
        const pageWidth = doc.internal.pageSize.getWidth();
        const margin = 15;
        let y = 15; // Posição vertical inicial

        const subsectionIndent = 5; // Indentação para as subseções inteiras

        // Helper function for adding text with line wrapping
        const addWrappedText = (text, x, y, maxWidth) => {
            if (typeof text !== 'string') {
                text = String(text);
            }
            const lines = doc.splitTextToSize(text, maxWidth);
            doc.text(lines, x, y);
            return (lines.length * 6) + 2; // Approximate height of the text block + margin
        };
        
        // Helper for adding a numbered subsection with an optional title.
        // Handles text wrapping and vertical spacing.
        const addSubsection = (number, title, content, x, y, maxWidth) => {
            if (title) {
                doc.setFont("times", "bold");
                // If there is a title, the number and title are on the first line, bold.
                const fullText = `${number} ${title}`;
                doc.text(fullText, x, y);
                let currentY = y + 6; // Move down for the content
                
                doc.setFont("times", "normal");

                if (content && content.length > 0) {
                    const lines = doc.splitTextToSize(content, maxWidth);
                    doc.text(lines, x, currentY);
                    // Return total height used: title + content + margin
                    return 6 + (lines.length * 6) + 2;
                }
                // Return height for title only + margin
                return 6 + 2;
            } else {
                // If there is no title, number and content are on the same line.
                doc.setFont("times", "bold");
                const numberText = `${number} `;
                doc.text(numberText, x, y); // Draw bold number
                
                // Calculate width of the number to position the content correctly
                const numberWidth = doc.getStringUnitWidth(numberText) * doc.internal.getFontSize() / doc.internal.scaleFactor;
                
                doc.setFont("times", "normal");
                // Add the wrapped content next to the number
                const textHeight = addWrappedText(content, x + numberWidth, y, maxWidth - numberWidth);

                // Return the height of the content
                return textHeight;
            }
        };

        // Helper for adding numbered list items
        const addNumberedItem = (number, content, x, y, maxWidth) => {
            doc.setFont("times", "bold");
            const numberText = `${number} `;
            doc.text(numberText, x, y);
            
            const numberWidth = doc.getStringUnitWidth(numberText) * doc.internal.getFontSize() / doc.internal.scaleFactor;
            
            doc.setFont("times", "normal");
            const lines = doc.splitTextToSize(content, maxWidth - numberWidth);
            doc.text(lines, x + numberWidth, y);
            
            return (lines.length * 6) + 2;
        };

        // Function to check for new page
        const checkPageBreak = (heightNeeded) => {
            if (y + heightNeeded > 282) { // 297mm - 15mm bottom margin
                doc.addPage();
                y = 15;
            }
        };
        
        // Helper function for adding explanatory notes without background
        const addNotaExplicativa = (title, content) => {
            const contentWidth = pageWidth - margin * 2;
            
            doc.setFont("times", "bold");
            const titleLines = doc.splitTextToSize(title, contentWidth);
            const titleHeight = (titleLines.length * 6);
            
            doc.setFont("times", "normal");
            const contentLines = doc.splitTextToSize(content, contentWidth);
            const contentHeight = (contentLines.length * 6);

            const notaHeight = titleHeight + contentHeight - 5;

            checkPageBreak(notaHeight + 5);
            
            let currentY = y + 5;
            
            doc.setFont("times", "bold");
            doc.text(titleLines, margin, currentY);
            currentY += titleHeight;
            
            doc.setFont("times", "normal");
            doc.text(contentLines, margin, currentY);
            
            y += notaHeight;
        };

        const addContent = () => {
            const contentWidth = pageWidth - margin * 2;
            const sectionSpacing = 4;

            // Section 1: DA DEFINIÇÃO DO OBJETO
            checkPageBreak(20);
            doc.setFontSize(12);
            doc.setFont("times", "bold");
            doc.text("1. DA DEFINIÇÃO DO OBJETO", margin, y);
            y += 7;
            doc.setFontSize(11);
            doc.setFont("times", "normal");
            
            // Subseção 1.1
            y += addSubsection("1.1", "", jsonData.objeto_contratacao, margin + subsectionIndent, y, contentWidth - subsectionIndent);

            // Subseção 1.2
            checkPageBreak(30);
            y += addSubsection("1.2", "Detalhamento dos bens que compõem a solução:", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            
            // Table Headers
            const tableHeaders = ["Item", "Descrição", "CATMAT", "Unidade", "Qtd", "V. Unit.", "V. Total"];
            const colWidths = [15, 55, 20, 20, 15, 25, 25]; // Total width = 175
            const tableStartX = margin + subsectionIndent;

            let currentX = tableStartX;
            doc.setFont("times", "bold");
            doc.setFontSize(10);
            const headerHeight = 10;
            tableHeaders.forEach((header, i) => {
                doc.rect(currentX, y, colWidths[i], headerHeight);
                const textWidth = doc.getStringUnitWidth(header) * doc.internal.getFontSize() / doc.internal.scaleFactor;
                const textX = currentX + (colWidths[i] - textWidth) / 2;
                doc.text(header, textX, y + headerHeight / 2 + 3);
                currentX += colWidths[i];
            });
            y += headerHeight;

            // Table Body
            doc.setFont("times", "normal");
            doc.setFontSize(10);

            jsonData.itens.forEach((item, index) => {
                const rowData = [
                    (index + 1).toString(),
                    item.descricao,
                    item.codigo_catmat_catser || '[A DEFINIR]',
                    item.unidade_medida,
                    item.quantidade.toString(),
                    `R$ ${parseFloat(item.valor_unitario).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
                    `R$ ${parseFloat(item.valor_total).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
                ];

                let maxLines = 0;
                const cellPadding = 2;
                const lineHeight = 6;

                // Calculate the required height for the row by finding the cell with the most lines
                rowData.forEach((text, i) => {
                    const lines = doc.splitTextToSize(String(text), colWidths[i] - (cellPadding * 2));
                    if (lines.length > maxLines) {
                        maxLines = lines.length;
                    }
                });
                
                const rowHeight = maxLines * lineHeight + (cellPadding * 2);
                
                checkPageBreak(rowHeight);
                
                currentX = tableStartX;
                
                // Draw row cells and text
                rowData.forEach((text, i) => {
                    doc.rect(currentX, y, colWidths[i], rowHeight);
                    const lines = doc.splitTextToSize(String(text), colWidths[i] - (cellPadding * 2));
                    
                    // CORREÇÃO: Adicionar cellPadding na posição vertical inicial do texto
                    const textY = y + cellPadding + lineHeight;
                    
                    // Para células com alinhamento à direita (valores monetários)
                    if (i >= 5) { // Colunas de valores (V. Unit. e V. Total)
                        lines.forEach((line, lineIndex) => {
                            const textWidth = doc.getStringUnitWidth(line) * doc.internal.getFontSize() / doc.internal.scaleFactor;
                            const textX = currentX + colWidths[i] - cellPadding - textWidth;
                            doc.text(line, textX, textY + (lineIndex * lineHeight));
                        });
                    } else {
                        doc.text(lines, currentX + cellPadding, textY);
                    }
                    
                    currentX += colWidths[i];
                });

                y += rowHeight;
            });
            doc.setFontSize(11);
            y += 10;
            
            // Subseção 1.3
            checkPageBreak(15);
            y += addSubsection("1.3", "", "Os bens objeto desta contratação são caracterizados como comuns, conforme indicado no Estudo Técnico Preliminar.", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            
            // Subseção 1.4
            checkPageBreak(15);
            y += addSubsection("1.4", "", "Demais regras das condições e especificações da solução: [acrescentar outras se houve alterações em relação às indicada no Estudo Técnico Preliminar]", margin + subsectionIndent, y, contentWidth - subsectionIndent);

            // Subseção 1.5
            checkPageBreak(15);
            const prazoVigencia = `O prazo de vigência da contratação é de ${jsonData.prazo_vigencia_contrato}`;
            y += addSubsection("1.5", "", prazoVigencia, margin + subsectionIndent, y, contentWidth - subsectionIndent);
            
            // Subseção 1.6
            checkPageBreak(15);
            y += addSubsection("1.6", "", "O contrato oferece maior detalhamento das regras que serão aplicadas em relação à vigência da contratação.", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            
            y += sectionSpacing;
            
            // Section 2: DA FUNDAMENTAÇÃO E DESCRIÇÃO DA NECESSIDADE DA CONTRATAÇÃO
            checkPageBreak(40);
            doc.setFontSize(12);
            doc.setFont("times", "bold");
            doc.text("2. DA FUNDAMENTAÇÃO E DESCRIÇÃO DA NECESSIDADE DA CONTRATAÇÃO", margin, y);
            y += 7;
            doc.setFontSize(11);
            doc.setFont("times", "normal");
            y += addSubsection("2.1", "", jsonData.fundamentacao_legal, margin + subsectionIndent, y, contentWidth - subsectionIndent);
            
            let previsaoPCATexto;
            if (jsonData.adequacao_orcamentaria.previsao_pca === true) {
                const codigoPCA = jsonData.adequacao_orcamentaria.codigo_pca || "[não informado]";
                previsaoPCATexto = `O objeto da contratação está previsto no Plano de Contratações Anual (PCA), sob o código PCA ${codigoPCA}.`;
            } else {
                previsaoPCATexto = `O objeto da contratação não está previsto no Plano de Contratações Anual (PCA).`;
            }

            y += addSubsection("2.2", "", previsaoPCATexto, margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += sectionSpacing;

            y += sectionSpacing;    

            checkPageBreak(120);
            doc.setFont("times", "bold");
            doc.text("2.3 DO CABIMENTO DO SISTEMA DE REGISTRO DE PREÇOS", margin + subsectionIndent, y);
            y += 7;
            doc.setFont("times", "normal");

            const srpData = jsonData.sistema_registro_precos;
            const textIndent = margin + subsectionIndent + 5;
            const textWidth = contentWidth - subsectionIndent - 5;

            if (srpData.adota_srp) {
                // I
                y += addWrappedText(`I - Será adotado o Sistema de Registro de Preços (SRP) (art. 78, IV, Lei 14.133/2021) para a contratação pretendida.`, textIndent, y, textWidth);

                // II
                const quantidadeMaximaTexto = srpData.tem_quantidade_maxima
                    ? 'Será prevista uma quantidade máxima a ser adquirida para cada item/grupo, de acordo com o quadro que constará no edital.'
                    : 'Não haverá quantidade máxima a ser adquirida para cada item/grupo.';
                y += addWrappedText(`II - ${quantidadeMaximaTexto}`, textIndent, y, textWidth);

                // III
                const quantidadeMinimaTexto = srpData.tem_quantidade_minima
                    ? `A quantidade mínima de unidades de bens a serem cotadas será de ${srpData.quantidade_minima_cotacao} unidade(s).`
                    : 'Não se aplica a previsão de quantidade mínima de unidades de bens a serem cotadas.';
                y += addWrappedText(`III - ${quantidadeMinimaTexto}`, textIndent, y, textWidth);

                // IV
                const precosDiferentesTexto = srpData.permite_precos_diferentes
                    ? `Será permitida a previsão de preços diferentes. ${srpData.justificativa_precos_diferentes || '[justificativa não informada].'}`
                    : 'Não será permitida a previsão de preços diferentes.';
                y += addWrappedText(`IV - ${precosDiferentesTexto}`, textIndent, y, textWidth);

                // V
                const propostaInferiorTexto = srpData.permite_proposta_inferior
                    ? 'O licitante poderá oferecer proposta com quantitativo inferior ao máximo previsto.'
                    : `O licitante não poderá oferecer proposta com quantitativo inferior ao máximo previsto. Justificativa: ${srpData.justificativa_nao_proposta_inferior || '[justificativa não informada].'}`;
                y += addWrappedText(`V - ${propostaInferiorTexto}`, textIndent, y, textWidth);

                // VI
                const criterioJulgamentoTexto = srpData.criterio_julgamento === 'grupo'
                    ? 'Menor preço por Grupo de Itens.'
                    : 'Menor preço por Item.';
                y += addWrappedText(`VI - O critério de julgamento a ser adotado será o de ${criterioJulgamentoTexto}`, textIndent, y, textWidth);

                // VII
                const registroLimitadoTexto = srpData.registro_limitado
                    ? `Será permitido o registro de preços com indicação limitada a unidades de contratação porque ${srpData.justificativa_registro_limitado || '[justificativa não informada].'}`
                    : 'Não será permitido o registro de preços com indicação limitada a unidades de contratação.';
                y += addWrappedText(`VII - ${registroLimitadoTexto}`, textIndent, y, textWidth);

                // VIII
                y += addWrappedText(`VIII - Os preços registrados poderão ser objeto de reajustamento, observados os requisitos exigidos pela Lei n. 14.133, de 2021.`, textIndent, y, textWidth);

                // IX
                y += addWrappedText(`IX - Para fins de reajustamento, será adotado o seguinte critério: ${srpData.criterio_reajuste || '[Critério não definido].'}`, textIndent, y, textWidth);
                
                // X
                y += addWrappedText(`X - O prazo de vigência da ata de registro de preços será de ${srpData.vigencia_ata || '[Prazo não definido].'}`, textIndent, y, textWidth);
            } else {
                y += addWrappedText(`Não será adotado o Sistema de Registro de Preços.`, textIndent, y, textWidth);
            }

            y += sectionSpacing;

            // Seção 3: DA DESCRIÇÃO DA SOLUÇÃO COMO UM TODO (ADICIONAR 3.1)
            checkPageBreak(30);
            doc.setFontSize(12);
            doc.setFont("times", "bold");

            const section3Title = "3. DA DESCRIÇÃO DA SOLUÇÃO COMO UM TODO CONSIDERADO O CICLO DE VIDA DO OBJETO E ESPECIFICAÇÃO DO PRODUTO";
            const titleHeight = addWrappedText(section3Title, margin, y, contentWidth);
            y += titleHeight;

            doc.setFontSize(11);
            doc.setFont("times", "normal");

            // ADICIONAR 3.1
            y += addSubsection("3.1", "", jsonData.descricao_solucao, margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += sectionSpacing;

            // Section 4: DOS REQUISITOS DA CONTRATAÇÃO
            checkPageBreak(60);
            doc.setFontSize(12);
            doc.setFont("times", "bold");
            doc.text("4. DOS REQUISITOS DA CONTRATAÇÃO", margin, y);
            y += 7;
            doc.setFontSize(11);
            doc.setFont("times", "normal");
            
            // ADICIONAR 4.1.1, 4.2.1, etc.
            checkPageBreak(15);
            y += addSubsection("4.1", "DA SUSTENTABILIDADE", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            checkPageBreak(30);
            y += addSubsection("4.1.1", "", jsonData.requisitos_contratacao.sustentabilidade, margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            
            checkPageBreak(15);
            y += addSubsection("4.2", "DA INDICAÇÃO DE MARCAS OU MODELOS", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            checkPageBreak(20);
            y += addSubsection("4.2.1", "", jsonData.requisitos_contratacao.indicacao_marcas, margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            
            checkPageBreak(15);
            y += addSubsection("4.3", "DA VEDAÇÃO DE UTILIZAÇÃO DE MARCA/PRODUTO", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            checkPageBreak(20);
            y += addSubsection("4.3.1", "", jsonData.requisitos_contratacao.vedacao_marca_produto, margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            
            checkPageBreak(15);
            y += addSubsection("4.4", "DA AMOSTRA", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            checkPageBreak(15);
            y += addSubsection("4.4.1", "", jsonData.requisitos_contratacao.exige_amostra ? 'Será exigida apresentação de amostra.' : 'Não será exigida apresentação de amostra.', margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            
            checkPageBreak(15);
            y += addSubsection("4.5", "DA CARTA DE SOLIDARIEDADE", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            checkPageBreak(15);
            y += addSubsection("4.5.1", "", jsonData.requisitos_contratacao.exige_carta_solidariedade ? 'Será exigida carta de solidariedade.' : 'Não será exigida carta de solidariedade.', margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            
            checkPageBreak(15);
            y += addSubsection("4.6", "DA SUBCONTRATAÇÃO", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            checkPageBreak(15);
            y += addSubsection("4.6.1", "", jsonData.admite_subcontratacao ? 'Admite-se subcontratação.' : 'Não se admite subcontratação.', margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            
            checkPageBreak(15);
            y += addSubsection("4.7", "DA GARANTIA DA CONTRATAÇÃO", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            checkPageBreak(20);
            y += addSubsection("4.7.1", "", jsonData.exige_garantia_contratual ? jsonData.requisitos_contratacao.garantia_produto_servico : 'Não se exige garantia contratual.', margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);

            y += sectionSpacing;

            // Section 5: DO MODELO DE EXECUÇÃO DO OBJETO
            checkPageBreak(100);
            doc.setFontSize(12);
            doc.setFont("times", "bold");
            doc.text("5. DO MODELO DE EXECUÇÃO DO OBJETO", margin, y);
            y += 7;
            doc.setFontSize(11);
            doc.setFont("times", "normal");
            y += addSubsection("5.1", "DAS CONDIÇÕES DE ENTREGA", jsonData.modelo_execucao.condicoes_entrega, margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += addSubsection("5.2", "DA GARANTIA, MANUTENÇÃO E ASSISTÊNCIA TÉCNICA", jsonData.modelo_execucao.garantia_manutencao, margin + subsectionIndent, y, contentWidth - subsectionIndent);
            
            // Subseção 5.3 com numeração
            checkPageBreak(15);
            y += addSubsection("5.3", "DOS DEVERES E RESPONSABILIDADES DO CONTRATANTE", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            jsonData.obrigacoes_contratante.forEach((item, index) => {
                checkPageBreak(10);
                y += addNumberedItem(`5.3.${index + 1}`, item, margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            });
            
            // Subseção 5.4 com numeração
            checkPageBreak(15);
            y += addSubsection("5.4", "DOS DEVERES E RESPONSABILIDADES DA CONTRATADA", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            jsonData.obrigacoes_contratada.forEach((item, index) => {
                checkPageBreak(10);
                y += addNumberedItem(`5.4.${index + 1}`, item, margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            });
            y += sectionSpacing;

            // Section 6: DO MODELO DE GESTÃO DO CONTRATO (ADICIONAR 6.1)
            checkPageBreak(20);
            doc.setFontSize(12);
            doc.setFont("times", "bold");
            doc.text("6. DO MODELO DE GESTÃO DO CONTRATO", margin, y);
            y += 7;
            doc.setFontSize(11);
            doc.setFont("times", "normal");
            
            // ADICIONAR 6.1
            y += addSubsection("6.1", "", jsonData.gestao_contrato.modelo_gestao, margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += sectionSpacing;
            
            // Section 7: DOS CRITÉRIOS DE PAGAMENTO
            checkPageBreak(50);
            doc.setFontSize(12);
            doc.setFont("times", "bold");
            doc.text("7. DOS CRITÉRIOS DE PAGAMENTO", margin, y);
            y += 7;
            doc.setFontSize(11);
            doc.setFont("times", "normal");
            
            // ADICIONAR 7.1.1, 7.2.1, etc.
            checkPageBreak(15);
            y += addSubsection("7.1", "DO RECEBIMENTO DO OBJETO", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            checkPageBreak(20);
            y += addSubsection("7.1.1", "", jsonData.criterios_pagamento.recebimento_objeto, margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            
            checkPageBreak(15);
            y += addSubsection("7.2", "DA LIQUIDAÇÃO", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            checkPageBreak(20);
            y += addSubsection("7.2.1", "", jsonData.criterios_pagamento.liquidacao, margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            
            checkPageBreak(15);
            y += addSubsection("7.3", "DO PRAZO DE PAGAMENTO", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            checkPageBreak(20);
            y += addSubsection("7.3.1", "", jsonData.criterios_pagamento.prazo_pagamento, margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            
            checkPageBreak(15);
            y += addSubsection("7.4", "DA FORMA DE PAGAMENTO", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            checkPageBreak(15);
            y += addSubsection("7.4.1", "", jsonData.criterios_pagamento.forma_pagamento, margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            
            checkPageBreak(15);
            y += addSubsection("7.5", "DA ANTECIPAÇÃO DE PAGAMENTO", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            checkPageBreak(15);
            y += addSubsection("7.5.1", "", jsonData.criterios_pagamento.antecipacao_pagamento ? 'Sim' : 'Não', margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            
            checkPageBreak(15);
            y += addSubsection("7.6", "DA CESSÃO DE CRÉDITO", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            checkPageBreak(20);
            y += addSubsection("7.6.1", "", jsonData.criterios_pagamento.cessao_credito, margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            
            y += sectionSpacing;

            // Section 8: DA FORMA E CRITÉRIO DE SELEÇÃO DO FORNECEDOR
            checkPageBreak(20);
            doc.setFontSize(12);
            doc.setFont("times", "bold");
            doc.text("8. DA FORMA E CRITÉRIO DE SELEÇÃO DO FORNECEDOR", margin, y);
            y += 7;
            doc.setFontSize(11);
            doc.setFont("times", "normal");
            
            // ADICIONAR 8.1.1
            y += addSubsection("8.1", "DA FORMA DE SELEÇÃO E CRITÉRIO DE JULGAMENTO DA PROPOSTA", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += addSubsection("8.1.1", "", `${jsonData.selecao_fornecedor.forma_selecao} - ${jsonData.selecao_fornecedor.criterio_julgamento}`, margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            
            // Subseção 8.2 com numeração
            checkPageBreak(15);
            y += addSubsection("8.2", "DAS EXIGÊNCIAS DE HABILITAÇÃO", "", margin + subsectionIndent, y, contentWidth - subsectionIndent);
            
            // 8.2.1 - Jurídica
            y += addNumberedItem("8.2.1", "Jurídica:", margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            jsonData.selecao_fornecedor.exigencias_habilitacao.juridica.forEach((item) => {
                checkPageBreak(10);
                y += addWrappedText(`• ${item}`, margin + subsectionIndent + 10, y, contentWidth - subsectionIndent - 10);
            });
            
            // 8.2.2 - Fiscal e Trabalhista
            checkPageBreak(15);
            y += addNumberedItem("8.2.2", "Fiscal e Trabalhista:", margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            jsonData.selecao_fornecedor.exigencias_habilitacao.fiscal_trabalhista.forEach((item) => {
                checkPageBreak(10);
                y += addWrappedText(`• ${item}`, margin + subsectionIndent + 10, y, contentWidth - subsectionIndent - 10);
            });

            // 8.2.3 - Econômico-Financeira
            checkPageBreak(15);
            y += addNumberedItem("8.2.3", "Econômico-Financeira:", margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            jsonData.selecao_fornecedor.exigencias_habilitacao.economico_financeira.forEach((item) => {
                checkPageBreak(10);
                y += addWrappedText(`• ${item}`, margin + subsectionIndent + 10, y, contentWidth - subsectionIndent - 10);
            });

            // 8.2.4 - Técnica
            checkPageBreak(15);
            y += addNumberedItem("8.2.4", "Técnica:", margin + subsectionIndent + 5, y, contentWidth - subsectionIndent - 5);
            jsonData.selecao_fornecedor.exigencias_habilitacao.tecnica.forEach((item) => {
                checkPageBreak(10);
                y += addWrappedText(`• ${item}`, margin + subsectionIndent + 10, y, contentWidth - subsectionIndent - 10);
            });
            y += sectionSpacing;

            // Section 9: DA ESTIMATIVA DO VALOR DA CONTRATAÇÃO (ADICIONAR 9.1, 9.2, 9.3)
            checkPageBreak(30);
            doc.setFontSize(12);
            doc.setFont("times", "bold");
            doc.text("9. DA ESTIMATIVA DO VALOR DA CONTRATAÇÃO", margin, y);
            y += 7;
            doc.setFontSize(11);
            doc.setFont("times", "normal");
            
            // ADICIONAR 9.1, 9.2, 9.3
            y += addSubsection("9.1", "Valor Total:", `R$ ${jsonData.estimativa_valor.valor_total}`, margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += addSubsection("9.2", "Valor Unitário:", `R$ ${jsonData.estimativa_valor.valor_unitario}`, margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += addSubsection("9.3", "Metodologia da Pesquisa:", jsonData.estimativa_valor.metodologia_pesquisa, margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += sectionSpacing;

            // Section 10: DA ADEQUAÇÃO ORÇAMENTÁRIA (ADICIONAR 10.1, 10.2)
            checkPageBreak(20);
            doc.setFontSize(12);
            doc.setFont("times", "bold");
            doc.text("10. DA ADEQUAÇÃO ORÇAMENTÁRIA", margin, y);
            y += 7;
            doc.setFontSize(11);
            doc.setFont("times", "normal");
            
            // ADICIONAR 10.1, 10.2
            y += addSubsection("10.1", "Fonte de Recursos:", jsonData.adequacao_orcamentaria.fonte_recursos, margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += addSubsection("10.2", "Classificação Orçamentária:", jsonData.adequacao_orcamentaria.classificacao_orcamentaria, margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += sectionSpacing;

            // Section 11: DAS INFRAÇÕES E SANÇÕES APLICÁVEIS (ADICIONAR 11.1)
            checkPageBreak(20);
            doc.setFontSize(12);
            doc.setFont("times", "bold");
            doc.text("11. DAS INFRAÇÕES E SANÇÕES APLICÁVEIS", margin, y);
            y += 7;
            doc.setFontSize(11);
            doc.setFont("times", "normal");
            
            // ADICIONAR 11.1
            y += addSubsection("11.1", "", jsonData.sancoes_administrativas, margin + subsectionIndent, y, contentWidth - subsectionIndent);
            y += 20;

            // Signature
            checkPageBreak(20);
            doc.text("________________________________________", pageWidth / 2, y, { align: "center" });
            y += 7;
            doc.text(jsonData.responsavel, pageWidth / 2, y, { align: "center" });
            y += 5;
            doc.text(jsonData.cargo_responsavel, pageWidth / 2, y, { align: "center" });
        }

        const addHeaderAndSave = () => {
            const brasaoImg = new Image();
            brasaoImg.src = "/static/assets/img/brasao_oficial_republica.png";

            const drawContentAndSave = () => {
                doc.setFontSize(9);
                doc.setFont("times", "normal");
                doc.text("TRIBUNAL REGIONAL ELEITORAL DO ACRE", pageWidth / 2, y, { align: "center" });
                y += 10;

                doc.setFontSize(8);
                doc.text("Alameda Ministro Miguel Ferrante, 224 - Bairro Portal da Amazônia - CEP 69915-632 - Rio Branco - AC", pageWidth / 2, y, { align: "center" });
                y += 10;

                doc.setFontSize(11);
                doc.text("ANEXO VIII", pageWidth / 2, y, { align: "center" });
                y += 15;

                doc.setFontSize(11);
                doc.setFont("times", "bold");
                doc.text("TERMO DE REFERÊNCIA (TR) PARA COMPRAS", pageWidth / 2, y, { align: "center" });
                y += 15;

                doc.setFontSize(11);
                doc.setFont("times", "bold");
                doc.text("TERMO DE REFERÊNCIA", pageWidth / 2, y, { align: "center" });
                y += 15;

                addContent();
                doc.save("Termo_de_Referencia.pdf");
            };

            brasaoImg.onload = () => {
                const targetWidth = 40;
                const aspectRatio = brasaoImg.height / brasaoImg.width;
                const targetHeight = targetWidth * aspectRatio;
                const xPosition = pageWidth / 2 - targetWidth / 2;

                y = 15;

                doc.addImage(brasaoImg, "PNG", xPosition, y, targetWidth, targetHeight);
                y += targetHeight + 10;

                drawContentAndSave();
            };

            brasaoImg.onerror = () => {
                console.error("Falha ao carregar imagem do brasão.");
                y = 15; // Reset Y position if image fails
                y += 40; // Approximate space for the missing image
                drawContentAndSave();
            };
        };

        addHeaderAndSave();
    }
</script>

</body>
</html>